/**
 * @fileoverview Firestore Security Rules for the Coffee Campus application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for private data (timetables, chat messages, notifications)
 * and a public-read, owner-write model for notices. User data is protected, and only authenticated users can
 * create content, with ownership validated on creation.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the owner.
 * - /notices/{noticeId}: Stores public notices, readable by all, but writable only by the author.
 * - /timetables/{userId}: Stores user timetables, accessible only to the owner.
 * - /chat_conversations/{userId}: Stores chat messages, accessible only to the owner.
 * - /users/{userId}/notifications/{notificationId}: Stores user notifications, accessible only to the owner.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Roles are not yet implemented (future enhancement with DBAC).
 * - Data shape validation is relaxed for rapid prototyping.
 *
 * Denormalization for Authorization:
 * - Notices store the authorId directly within the document, avoiding the need for `get()` calls during authorization.
 *
 * Structural Segregation:
 * - Private user data (timetables, chat messages, notifications) is stored under the /users/{userId} path,
 *   while public notices are stored in the top-level /notices collection. This ensures a clear separation
 *   of concerns and simplifies access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the authenticated user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the existing owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {boolean} True if the authenticated user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for all collections during testing.
     * @principle Allow read and write access to any authenticated user for testing purposes.
     */
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
