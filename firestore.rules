/**
 * @fileoverview Firestore Security Rules for the College Companion application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for private data (timetables, chat messages, notifications)
 * and an admin-only write model for public notices. User data is protected, and only authenticated users can
 * read content, with write access being role-based.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the owner.
 * - /notices/{noticeId}: Stores public notices, readable by all, but writable only by admins.
 * - /timetables/{userId}: Stores user timetables, accessible only to the owner.
 * - /chat_conversations/{userId}: Stores chat messages, accessible only to the owner.
 * - /users/{userId}/notifications/{notificationId}: Stores user notifications, accessible only to the owner.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Role-based access control (RBAC) is implemented for notices using a specific admin UID.
 * - Data shape validation is relaxed for rapid prototyping.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin by their UID.
    // Replace 'THE_ADMINS_USER_ID' with the actual UID of the admin user.
    function isAdmin() {
      // This is a placeholder check. In a real app, you would have a list of admin UIDs
      // or check a custom claim. For this prototype, we check the user's role in their profile.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users can only access their own profile data.
    match /users/{userId} {
      allow read, update, delete: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;
    }

    // Notices can be read by any authenticated user, but only created, updated, or deleted by an admin.
    match /notices/{noticeId} {
      allow read: if request.auth.uid != null;
      allow create, update, delete: if isAdmin();
    }
    
    // Timetables can only be accessed by their owner.
    match /timetables/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Chat conversations can only be accessed by their owner.
    // Note: This rule applies to the collection. A subcollection for messages would need its own rules.
    match /chat_conversations/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Notifications are part of a user's subcollection and can only be accessed by the owner.
    match /users/{userId}/notifications/{notificationId} {
       allow read, write: if request.auth.uid == userId;
    }
  }
}
